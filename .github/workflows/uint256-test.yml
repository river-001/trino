name: Trino Build and Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # 允许手动触发

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      # 如需缓存权限，可添加：
      # actions: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # 拉取完整历史，避免Trino构建依赖问题

      - name: Setup environment using custom action
        uses: ./.github/actions/setup  # 替换为你的setup动作实际路径
        with:
          java-version: 24  # Trino通常推荐使用LTS版本，21是较新的LTS
          cache: true       # 启用缓存加速Maven依赖下载
          cleanup-node: true  # 清理Node环境释放磁盘空间（Trino构建可能需要较大空间）

      - name: Build Trino (skip tests)
        run: |
          # Trino的mvnw需要执行权限，先确保权限正确
          chmod +x ./mvnw
          # 执行编译（跳过测试以加快构建）
          sudo ./mvnw clean install -DskipTests
        env:
          MAVEN_OPTS: "-Xmx4g"  # 增加Maven堆内存，避免OOM

      - name: Run PTL tests
        run: |
          # 确保测试脚本有执行权限
          chmod +x testing/bin/ptl
          # 运行指定环境的测试
          sudo testing/bin/ptl test run \
            --environment singlenode-spark-iceberg \
            -- -g uint256
        env:
          # 配置测试环境变量（根据需要添加）
          TESTING_OPTS: "-Dtest.timeout=300000"  # 延长测试超时时间（5分钟）
